<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Olas Live â€” Admin</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    fieldset { border: 1px solid #ddd; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; }
    legend { padding: 0 8px; font-weight: 600; }
    label { display:block; margin: 8px 0 4px; font-size: 14px; }
    input, select, button { font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items: end; }
    .muted { color: #666; font-size: 12px; }
    .ok { color: #0a6; font-weight: 600; }
    .bad { color: #b00; font-weight: 600; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Olas Live â€” <small>Panel de AdministraciÃ³n</small></h1>

  <fieldset>
    <legend>Evento</legend>
    <div class="row">
      <div>
        <label>Event ID</label>
        <input id="eventId" placeholder="p.ej. FIESTA-2025" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="connectBtn">Conectar</button>
        <button id="disconnectBtn" disabled>Desconectar</button>
      </div>
    </div>
    <div style="margin-top:8px" class="muted">
      Estado: <span id="status">Desconectado</span> Â· Conectados: <span id="count">0</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Efectos</legend>
    <div class="row">
      <div>
        <label>Efecto</label>
        <select id="effect">
          <option value="solid">Color sÃ³lido</option>
          <option value="blink">Parpadeo</option>
          <option value="wave">Ola</option>
          <option value="gradient">Gradiente</option>
        </select>
      </div>
      <div>
        <label>Color A</label>
        <input id="colorA" type="color" value="#00ff88" />
      </div>
      <div>
        <label>Color B (algunos efectos)</label>
        <input id="colorB" type="color" value="#002244" />
      </div>
      <div>
        <label>Velocidad (ms)</label>
        <input id="speed" type="number" value="500" min="50" step="10" />
      </div>
      <div>
        <label>Intensidad (0.1â€“1.0)</label>
        <input id="intensity" type="number" value="1" min="0.1" max="1" step="0.1" />
      </div>
      <div>
        <label>Grupo (opcional)</label>
        <input id="targetGroup" placeholder="TODOS si vacÃ­o" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="startBtn">Iniciar (1s)</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="stopBtn">Detener</button>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Mosaico (imagen â†’ cuadrÃ­cula)</legend>
    <div class="row">
      <div>
        <label>Imagen</label>
        <input id="imageFile" type="file" accept="image/*" />
      </div>
      <div>
        <label>Ancho (W)</label>
        <input id="gridW" type="number" value="60" min="4" max="200" />
      </div>
      <div>
        <label>Alto (H)</label>
        <input id="gridH" type="number" value="30" min="4" max="120" />
      </div>
      <div>
        <label>Intensidad (0.1â€“1.0)</label>
        <input id="mosaicIntensity" type="number" value="1" min="0.1" max="1" step="0.1" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="sendMosaicBtn">Enviar mosaico</button>
      </div>
    </div>
    <div class="muted">Consejo: Elige WÃ—H similar a filasÃ—columnas del recinto. La imagen se reescala.</div>
  </fieldset>

  <script>
    // ðŸ‘‰ RELLENAR con tu proyecto
    const SUPABASE_URL = "https://jnwqnflkuewbylbaeryc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impud3FuZmxrdWV3YnlsYmFlcnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczODY2NzIsImV4cCI6MjA3Mjk2MjY3Mn0.lw0ClyoR_SR1scUcWbLGEmk76LTf3KLbcCB1E1s1kh0";

    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const els = {
      eventId: document.getElementById('eventId'),
      connectBtn: document.getElementById('connectBtn'),
      disconnectBtn: document.getElementById('disconnectBtn'),
      status: document.getElementById('status'),
      count: document.getElementById('count'),
      effect: document.getElementById('effect'),
      colorA: document.getElementById('colorA'),
      colorB: document.getElementById('colorB'),
      speed: document.getElementById('speed'),
      intensity: document.getElementById('intensity'),
      targetGroup: document.getElementById('targetGroup'),
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      imageFile: document.getElementById('imageFile'),
      gridW: document.getElementById('gridW'),
      gridH: document.getElementById('gridH'),
      mosaicIntensity: document.getElementById('mosaicIntensity'),
      sendMosaicBtn: document.getElementById('sendMosaicBtn'),
    };

    let channel = null;
    const adminKey = 'admin-' + Math.random().toString(36).slice(2);

    function setUiConnected(connected) {
      els.connectBtn.disabled = connected;
      els.disconnectBtn.disabled = !connected;
      els.status.textContent = connected ? 'Conectado' : 'Desconectado';
      els.status.className = connected ? 'ok' : 'bad';
    }

    async function connect() {
      const id = (els.eventId.value || '').trim();
      if (!id) return alert('Ingresa un Event ID');

      channel = sb.channel(`event:${id}`, {
        config: {
          broadcast: { ack: true },
          presence: { key: adminKey }
        }
      });

      channel.on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        let total = 0;
        for (const key in state) total += state[key].length;
        els.count.textContent = String(total);
      });

      channel.subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          channel.track({ role: 'admin', t: Date.now() });
          setUiConnected(true);
        }
      });
    }

    async function disconnect() {
      if (channel) {
        await channel.unsubscribe();
        channel = null;
      }
      setUiConnected(false);
    }

    function payloadEffect() {
      return {
        effect: els.effect.value,
        colors: [els.colorA.value, els.colorB.value],
        speedMs: Math.max(50, Number(els.speed.value) || 500),
        intensity: Math.min(1, Math.max(0.1, Number(els.intensity.value) || 1)),
      };
    }

    async function sendEffect(start = true) {
      if (!channel) return alert('ConÃ©ctate primero');
      const startAt = start ? Date.now() + 1000 : undefined;
      const targetGroup = (els.targetGroup.value || '').trim() || null;
      const payload = payloadEffect();
      await channel.send({
        type: 'broadcast',
        event: 'cmd',
        payload: { type: 'effect', startAt, targetGroup, payload }
      });
    }

    async function stopAll() {
      if (!channel) return;
      const targetGroup = (els.targetGroup.value || '').trim() || null;
      await channel.send({ type:'broadcast', event:'cmd', payload: { type:'stop', targetGroup } });
    }

    // Mosaico: redimensionar imagen a WÃ—H y enviar como dataURL
    async function sendMosaic() {
      if (!channel) return alert('ConÃ©ctate primero');
      const file = els.imageFile.files?.[0];
      if (!file) return alert('Selecciona una imagen');
      const W = Math.max(4, Number(els.gridW.value) || 60);
      const H = Math.max(4, Number(els.gridH.value) || 30);
      const intensity = Math.min(1, Math.max(0.1, Number(els.mosaicIntensity.value) || 1));

      const bitmap = await createImageBitmap(file);
      const cnv = document.createElement('canvas');
      cnv.width = W; cnv.height = H;
      const ctx = cnv.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(bitmap, 0, 0, W, H);
      const dataUrl = cnv.toDataURL('image/png');

      await channel.send({
        type: 'broadcast',
        event: 'cmd',
        payload: {
          type: 'mosaic',
          startAt: Date.now() + 1200,
          targetGroup: null,
          payload: { width: W, height: H, imageDataUrl: dataUrl, intensity }
        }
      });
      alert('Mosaico enviado. Pide a la gente verificar sus (x,y).');
    }

    // Wire-up UI
    els.connectBtn.addEventListener('click', connect);
    els.disconnectBtn.addEventListener('click', disconnect);
    els.startBtn.addEventListener('click', () => sendEffect(true));
    els.stopBtn.addEventListener('click', stopAll);
    els.sendMosaicBtn.addEventListener('click', sendMosaic);
  </script>
</body>
</html>
